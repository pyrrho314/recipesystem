

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gempy.science.geminiScience &mdash; gempy v0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="gempy v0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../../index.html">gempy v0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for gempy.science.geminiScience</h1><div class="highlight"><pre>
<span class="c">#Author: Kyle Mede, January 2011</span>
<span class="c">#For now, this module is to hold the code which performs the actual work of the </span>
<span class="c">#primitives that is considered generic enough to be at the &#39;gemini&#39; level of</span>
<span class="c">#the hierarchy tree.</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">astrodata.adutils</span> <span class="kn">import</span> <span class="n">gemLog</span>
<span class="kn">from</span> <span class="nn">astrodata.AstroData</span> <span class="kn">import</span> <span class="n">AstroData</span>
<span class="kn">from</span> <span class="nn">astrodata.adutils.gemutil</span> <span class="kn">import</span> <span class="n">pyrafLoader</span>
<span class="kn">from</span> <span class="nn">astrodata.Errors</span> <span class="kn">import</span> <span class="n">ScienceError</span>
<span class="kn">from</span> <span class="nn">gempy.instruments</span> <span class="kn">import</span> <span class="n">geminiTools</span>  <span class="k">as</span> <span class="n">gemt</span>
<span class="kn">from</span> <span class="nn">gempy.instruments.geminiCLParDicts</span> <span class="kn">import</span> <span class="n">CLDefaultParamsDict</span>

<div class="viewcode-block" id="add_bpm"><a class="viewcode-back" href="../../../sciFunctions/function-add_bpm.html#gempy.science.geminiScience.add_bpm">[docs]</a><span class="k">def</span> <span class="nf">add_bpm</span><span class="p">(</span><span class="n">adInputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">BPMs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">matchSize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  
                <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will add the provided BPM (Bad Pixel Mask) to the inputs.  </span>
<span class="sd">    The BPM will be added as frames matching that of the SCI frames and ensure</span>
<span class="sd">    the BPM&#39;s data array is the same size as that of the SCI data array.  If the </span>
<span class="sd">    SCI array is larger (say SCI&#39;s were overscan trimmed, but BPMs were not), </span>
<span class="sd">    theBPMs will have their arrays padded with zero&#39;s to match the sizes and use  </span>
<span class="sd">    the data_section descriptor on the SCI data arrays to ensure the match is</span>
<span class="sd">    a correct fit.  There must be a matching number of DQ extensions in the BPM </span>
<span class="sd">    as the input the BPM frames are to be added to </span>
<span class="sd">    (ie. if input has 3 SCI extensions, the BPM must have 3 DQ extensions).</span>
<span class="sd">    </span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">          </span>
<span class="sd">    :param adInputs: Astrodata inputs to be converted to Electron pixel units</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param BPMs: The BPM(s) to be added to the input(s).</span>
<span class="sd">    :type BPMs: </span>
<span class="sd">       AstroData objects in a list, or a single instance.</span>
<span class="sd">       Note: If there is multiple inputs and one BPM provided, then the</span>
<span class="sd">       same BPM will be applied to all inputs; else the BPMs list  </span>
<span class="sd">       must match the length of the inputs.</span>
<span class="sd">           </span>
<span class="sd">    :param matchSize: A flag to use zeros and the key &#39;DETSEC&#39; of the &#39;SCI&#39;</span>
<span class="sd">                      extensions to match the size of the BPM arrays to those </span>
<span class="sd">                      of for the &#39;SCI&#39; data arrays.</span>
<span class="sd">    :type matchSize: Python boolean (True/False). Default: False.</span>
<span class="sd">                      </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same </span>
<span class="sd">                    length as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                   (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                     default is &#39;critical&#39; messages only.</span>
<span class="sd">                     Note: independent of logLevel setting, all messages always go </span>
<span class="sd">                     to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;add_bpm&#39;</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
                   
    <span class="k">if</span> <span class="n">BPMs</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;There must be at least one BPM provided, the </span><span class="se">\</span>
<span class="s">                                        &quot;BPMs&quot; parameter must not be None.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">()</span>
                   
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames/BPMs lists</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c"># Do the work on each ad in the inputs</span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>
            <span class="c"># Getting the right BPM for this input</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">BPMs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">BPMs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">BPM</span> <span class="o">=</span> <span class="n">BPMs</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">BPM</span> <span class="o">=</span> <span class="n">BPMs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">BPM</span> <span class="o">=</span> <span class="n">BPMs</span>
            
            <span class="c"># Check if this input all ready has a BPM extension</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ad</span><span class="p">[</span><span class="s">&#39;BPM&#39;</span><span class="p">]:</span>
                <span class="c"># Making a deepcopy of the input to work on</span>
                <span class="c"># (ie. a truly new+different object that is a complete copy of the input)</span>
                <span class="n">adOut</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
                <span class="c"># moving the filename over as deepcopy doesn&#39;t do that</span>
                <span class="c"># only for internal use, renamed below to final name.</span>
                <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
                
                <span class="c"># Getting the filename for the BPM and removing any paths</span>
                <span class="n">BPMfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">BPM</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">sciExt</span> <span class="ow">in</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]:</span>
                    <span class="c"># Extracting the matching DQ extension from the BPM </span>
                    <span class="n">BPMArrayIn</span> <span class="o">=</span> <span class="n">BPM</span><span class="p">[(</span><span class="s">&#39;DQ&#39;</span><span class="p">,</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span><span class="o">.</span><span class="n">data</span>
                    
                    <span class="c"># logging the BPM file being used for this SCI extension</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;SCI extension number &#39;</span><span class="o">+</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span><span class="s">&#39;, of file &#39;</span><span class="o">+</span>
                                 <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span> 
                                 <span class="s">&#39; is matched to DQ extension &#39;</span>
                                 <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span><span class="s">&#39; of BPM file &#39;</span><span class="o">+</span>
                                 <span class="n">BPMfilename</span><span class="p">)</span>
                    
                    <span class="c"># Matching size of BPM array to that of the SCI data array</span>
                    <span class="k">if</span> <span class="n">matchSize</span><span class="p">:</span>
                        <span class="c"># Getting the data section from the header and as a dict</span>
                        <span class="c"># and grabbing the integer list from it, then finding</span>
                        <span class="c"># its shape</span>
                        <span class="n">datasecDict</span> <span class="o">=</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">data_section</span><span class="p">()</span>
                        <span class="c"># NOTE: this list is zero based, like python and numpy</span>
                        <span class="n">datasecList</span> <span class="o">=</span> <span class="n">datasecDict</span><span class="p">[(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extname</span><span class="p">(),</span>
                                                   <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span> 
                        <span class="n">dsl</span> <span class="o">=</span> <span class="n">datasecList</span>
                        <span class="n">datasecShape</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        
                        <span class="c"># Creating a zeros array the same size as SCI array</span>
                        <span class="c"># for this extension</span>
                        <span class="n">BPMArrayOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                               <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    
                        <span class="c"># Loading up zeros array with data from BPM array</span>
                        <span class="c"># if the sizes match then there is no change, else</span>
                        <span class="c"># output BPM array will be &#39;padded with zeros&#39; or </span>
                        <span class="c"># &#39;not bad pixels&#39; to match SCI&#39;s size.</span>
                        <span class="c"># NOTE: first elements of arrays in python are inclusive</span>
                        <span class="c">#       while last ones are exclusive, thus a 1 must be </span>
                        <span class="c">#       added for the final element to be included.</span>
                        <span class="k">if</span> <span class="n">BPMArrayIn</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">datasecShape</span><span class="p">:</span>
                            <span class="n">BPMArrayOut</span><span class="p">[</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                                                                <span class="n">BPMArrayIn</span>
                        <span class="k">elif</span> <span class="n">BPMArrayIn</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">BPMArrayOut</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                            <span class="n">BPMArrayOut</span><span class="p">[</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">BPMArrayIn</span><span class="p">[</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    
                    <span class="c"># Don&#39;t match size</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">BPMArrayOut</span> <span class="o">=</span> <span class="n">BPMArrayIn</span>
                        
                    <span class="c"># Creating a header for the BPM array and updating</span>
                    <span class="c"># further updating to this header will take place in </span>
                    <span class="c"># addDQ primitive</span>
                    <span class="n">BPMheader</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span> 
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;BITPIX&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> 
                                    <span class="s">&#39;number of bits per data pixel&#39;</span><span class="p">)</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;PCOUNT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
                                    <span class="s">&#39;required keyword; must = 0&#39;</span><span class="p">)</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;GCOUNT&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
                                    <span class="s">&#39;required keyword; must = 1&#39;</span><span class="p">)</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;BUNIT&#39;</span><span class="p">,</span> <span class="s">&#39;bit&#39;</span><span class="p">,</span> <span class="s">&#39;Physical units&#39;</span><span class="p">)</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;BPMFILE&#39;</span><span class="p">,</span> <span class="n">BPMfilename</span><span class="p">,</span> 
                                        <span class="s">&#39;Bad Pixel Mask file name&#39;</span><span class="p">)</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTVER&#39;</span><span class="p">,</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">(),</span> 
                                        <span class="s">&#39;Extension Version&#39;</span><span class="p">)</span>
                    <span class="c"># This extension will be renamed DQ in addDQ</span>
                    <span class="n">BPMheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME&#39;</span><span class="p">,</span> <span class="s">&#39;BPM&#39;</span><span class="p">,</span> <span class="s">&#39;Extension Name&#39;</span><span class="p">)</span>
                    
                    <span class="c"># Creating an astrodata instance from the </span>
                    <span class="c"># DQ array and header</span>
                    <span class="n">bpmAD</span> <span class="o">=</span> <span class="n">AstroData</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">BPMheader</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">BPMArrayOut</span><span class="p">)</span>
                    
                    <span class="c"># Using renameExt to correctly set the EXTVER and </span>
                    <span class="c"># EXTNAME values in the header   </span>
                    <span class="n">bpmAD</span><span class="o">.</span><span class="n">renameExt</span><span class="p">(</span><span class="s">&#39;BPM&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span>
                    
                    <span class="c"># Appending BPM astrodata instance to the input one</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Appending new BPM HDU onto the file &#39;</span><span class="o">+</span> 
                              <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">adOut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bpmAD</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Appending BPM complete for &#39;</span><span class="o">+</span> <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        
            <span class="c"># If BPM frames exist, send a warning message to the logger</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;BPM frames all ready exist for &#39;</span><span class="o">+</span>
                             <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;, so addBPM will add new ones&#39;</span><span class="p">)</span>
                
            <span class="c"># Updating GEM-TLM (automatic) and ADDBPM time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;ADDBPM&#39;</span><span class="p">)</span>

            <span class="c"># renaming the output ad filename</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">outNames</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                    
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;File name updated to &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="c"># Appending to output list</span>
            <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the add_bpm function&#39;</span><span class="p">)</span>
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run add_bpm&#39;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="add_dq"><a class="viewcode-back" href="../../../sciFunctions/function-add_dq.html#gempy.science.geminiScience.add_dq">[docs]</a><span class="k">def</span> <span class="nf">add_dq</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">fl_nonlinear</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fl_saturated</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will create a numpy array for the data quality </span>
<span class="sd">    of each SCI frame of the input data. This will then have a </span>
<span class="sd">    header created and append to the input using AstroData as a DQ </span>
<span class="sd">    frame. The value of a pixel will be the sum of the following: </span>
<span class="sd">    (0=good, 1=bad pixel (found in bad pixel mask), </span>
<span class="sd">    2=value is non linear, 4=pixel is saturated)</span>
<span class="sd">    </span>
<span class="sd">    NOTE: </span>
<span class="sd">    For every SCI extension of the inputs, a matching BPM extension must</span>
<span class="sd">    also exist to be updated with the non-linear and saturated pixels from</span>
<span class="sd">    the SCI data array for creation of the DQ array.</span>
<span class="sd">    ie. for now, no BPM extensions=this function will crash</span>
<span class="sd">          </span>
<span class="sd">    NOTE:</span>
<span class="sd">    FIND A WAY TO TAKE CARE OF NO BPM EXTENSION EXISTS ISSUE, OR ALLOWING THEM</span>
<span class="sd">    TO PASS IT IN...</span>
<span class="sd">    </span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to have DQ extensions added to</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param fl_nonlinear: Flag to turn checking for nonlinear pixels on/off</span>
<span class="sd">    :type fl_nonLinear: Python boolean (True/False), default is True</span>
<span class="sd">    </span>
<span class="sd">    :param fl_saturated: Flag to turn checking for saturated pixels on/off</span>
<span class="sd">    :type fl_saturated: Python boolean (True/False), default is True</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length </span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: </span>
<span class="sd">       string to add on the end of the input filenames </span>
<span class="sd">       (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: </span>
<span class="sd">         verbosity setting for the log messages to screen,</span>
<span class="sd">         default is &#39;critical&#39; messages only.</span>
<span class="sd">         Note: independent of logLevel setting, all messages always go </span>
<span class="sd">         to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;add_dq&#39;</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c"># Loop through the inputs to perform the non-linear and saturated</span>
        <span class="c"># pixel searches of the SCI frames to update the BPM frames into</span>
        <span class="c"># full DQ frames. </span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>                
            <span class="c"># Check if DQ extensions all ready exist for this file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ad</span><span class="p">[</span><span class="s">&#39;DQ&#39;</span><span class="p">]:</span>
                <span class="c"># Making a deepcopy of the input to work on</span>
                <span class="c"># (ie. a truly new+different object that is a complete copy of the input)</span>
                <span class="n">adOut</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
                <span class="c"># moving the filename over as deepcopy doesn&#39;t do that</span>
                <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
                
                <span class="k">for</span> <span class="n">sciExt</span> <span class="ow">in</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]:</span> 
                    <span class="c"># Retrieving BPM extension </span>
                    <span class="n">bpmAD</span> <span class="o">=</span> <span class="n">adOut</span><span class="p">[(</span><span class="s">&#39;BPM&#39;</span><span class="p">,</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span>
                    
                    <span class="c"># Extracting the BPM data array for this extension</span>
                    <span class="n">BPMArray</span> <span class="o">=</span> <span class="n">bpmAD</span><span class="o">.</span><span class="n">data</span>
                    
                    <span class="c"># Extracting the BPM header for this extension to be </span>
                    <span class="c"># later converted to a DQ header</span>
                    <span class="n">dqheader</span> <span class="o">=</span> <span class="n">bpmAD</span><span class="o">.</span><span class="n">header</span>
                    
                    <span class="c"># Preparing the non linear and saturated pixel arrays</span>
                    <span class="c"># and their respective constants</span>
                    <span class="n">nonLinArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
                    <span class="n">saturatedArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                              <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
                    <span class="n">linear</span> <span class="o">=</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">non_linear_level</span><span class="p">()</span>
                    <span class="n">saturated</span> <span class="o">=</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">saturation_level</span><span class="p">()</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">linear</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fl_nonlinear</span><span class="p">):</span> 
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Performing an np.where to find &#39;</span><span class="o">+</span>
                                  <span class="s">&#39;non-linear pixels for extension &#39;</span><span class="o">+</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span><span class="s">&#39; of &#39;</span><span class="o">+</span>
                                  <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                        <span class="n">nonLinArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">&gt;</span><span class="n">linear</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Done calculating array of non-linear&#39;</span><span class="o">+</span>
                                   <span class="s">&#39; pixels&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">saturated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fl_saturated</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Performing an np.where to find &#39;</span><span class="o">+</span>
                                  <span class="s">&#39;saturated pixels for extension &#39;</span><span class="o">+</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span><span class="s">&#39; of &#39;</span><span class="o">+</span>
                                  <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                        <span class="n">saturatedArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">&gt;</span><span class="n">saturated</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Done calculating array of saturated&#39;</span><span class="o">+</span>
                                   <span class="s">&#39; pixels&#39;</span><span class="p">)</span> 
                    
                    <span class="c"># Creating one DQ array from the three</span>
                    <span class="n">dqArray</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BPMArray</span><span class="p">,</span> <span class="n">nonLinArray</span><span class="p">,</span> 
                                   <span class="n">saturatedArray</span><span class="p">)</span> 
                    <span class="c"># Updating data array for the BPM array to be the </span>
                    <span class="c"># newly calculated DQ array</span>
                    <span class="n">adOut</span><span class="p">[(</span><span class="s">&#39;BPM&#39;</span><span class="p">,</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">dqArray</span>
                    
                    <span class="c"># Renaming the extension to DQ from BPM</span>
                    <span class="n">dqheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME&#39;</span><span class="p">,</span> <span class="s">&#39;DQ&#39;</span><span class="p">,</span> <span class="s">&#39;Extension Name&#39;</span><span class="p">)</span>
                    
                    <span class="c"># Using renameExt to correctly set the EXTVER and </span>
                    <span class="c"># EXTNAME values in the header   </span>
                    <span class="n">bpmAD</span><span class="o">.</span><span class="n">renameExt</span><span class="p">(</span><span class="s">&#39;DQ&#39;</span><span class="p">,</span> <span class="n">ver</span><span class="o">=</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">(),</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="c"># Logging that the name of the BPM extension was changed</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;BPM Extension &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span>
                                 <span class="s">&#39; of &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39; had its EXTVER &#39;</span><span class="o">+</span>
                                 <span class="s">&#39;changed to &#39;</span><span class="o">+</span>
                                 <span class="n">adOut</span><span class="p">[(</span><span class="s">&#39;DQ&#39;</span><span class="p">,</span>
                                        <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;EXTNAME&#39;</span><span class="p">])</span>
                    
            <span class="c"># If DQ frames exist, send a warning message to the logger</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;DQ frames all ready exist for &#39;</span><span class="o">+</span>
                             <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span>
                             <span class="s">&#39;, so addDQ will not calculate new ones&#39;</span><span class="p">)</span>
                
            <span class="c"># Updating GEM-TLM (automatic) and ADDDQ time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;ADDDQ&#39;</span><span class="p">)</span>

            <span class="c"># renaming the output ad filename</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">outNames</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                    
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;File name updated to &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="c"># Appending to output list</span>
            <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the add_dq function&#39;</span><span class="p">)</span>
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run add_dq&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="add_var"><a class="viewcode-back" href="../../../sciFunctions/function-add_var.html#gempy.science.geminiScience.add_var">[docs]</a><span class="k">def</span> <span class="nf">add_var</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                            <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function uses numpy to calculate the variance of each SCI frame</span>
<span class="sd">    in the input files and appends it as a VAR frame using AstroData.</span>
<span class="sd">    </span>
<span class="sd">    The calculation will follow the formula:</span>
<span class="sd">    variance = (read noise/gain)2 + max(data,0.0)/gain</span>
<span class="sd">    </span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to have DQ extensions added to</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length </span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: </span>
<span class="sd">        string to add on the end of the input filenames </span>
<span class="sd">        (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>

<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: </span>
<span class="sd">        verbosity setting for the log messages to screen,</span>
<span class="sd">        default is &#39;critical&#39; messages only.</span>
<span class="sd">        Note: independent of logLevel setting, all messages always go </span>
<span class="sd">        to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;add_var&#39;</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c"># Loop through the inputs to perform the non-linear and saturated</span>
        <span class="c"># pixel searches of the SCI frames to update the BPM frames into</span>
        <span class="c"># full DQ frames. </span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>   
            <span class="c"># Making a deepcopy of the input to work on</span>
            <span class="c"># (ie. a truly new+different object that is a complete copy of the input)</span>
            <span class="n">adOut</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
            <span class="c"># moving the filename over as deepcopy doesn&#39;t do that</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
            
            <span class="c"># To clean up log and screen if multiple inputs</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>
            <span class="c"># Check if there VAR frames all ready exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;VAR&#39;</span><span class="p">]:</span>                 
                <span class="c"># If VAR frames don&#39;t exist, loop through the SCI extensions </span>
                <span class="c"># and calculate a corresponding VAR frame for it, then </span>
                <span class="c"># append it</span>
                <span class="k">for</span> <span class="n">sciExt</span> <span class="ow">in</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]:</span>
                    <span class="c"># var = (read noise/gain)2 + max(data,0.0)/gain</span>
                    
                    <span class="c"># Retrieving necessary values (read noise, gain)</span>
                    <span class="n">readNoiseDict</span><span class="o">=</span><span class="n">sciExt</span><span class="o">.</span><span class="n">read_noise</span><span class="p">()</span>
                    <span class="n">readNoise</span> <span class="o">=</span> <span class="n">readNoiseDict</span><span class="p">[(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extname</span><span class="p">(),</span>
                                               <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span> 
                    <span class="n">gainDict</span><span class="o">=</span><span class="n">sciExt</span><span class="o">.</span><span class="n">gain</span><span class="p">()</span>
                    <span class="n">gain</span> <span class="o">=</span> <span class="n">gainDict</span><span class="p">[(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extname</span><span class="p">(),</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span> 
                    <span class="c"># Creating (read noise/gain) constant</span>
                    <span class="n">rnOverG</span><span class="o">=</span><span class="n">readNoise</span><span class="o">/</span><span class="n">gain</span>
                    <span class="c"># Convert negative numbers (if they exist) to zeros</span>
                    <span class="n">maxArray</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="c"># Creating max(data,0.0)/gain array</span>
                    <span class="n">maxOverGain</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">maxArray</span><span class="p">,</span><span class="n">gain</span><span class="p">)</span>
                    <span class="c"># Putting it all together</span>
                    <span class="n">varArray</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">maxOverGain</span><span class="p">,</span><span class="n">rnOverG</span><span class="o">*</span><span class="n">rnOverG</span><span class="p">)</span>
                     
                    <span class="c"># Creating the variance frame&#39;s header and updating it     </span>
                    <span class="n">varheader</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
                    <span class="n">varheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">varheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;PCOUNT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
                                     <span class="s">&#39;required keyword; must = 0 &#39;</span><span class="p">)</span>
                    <span class="n">varheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;GCOUNT&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
                                     <span class="s">&#39;required keyword; must = 1&#39;</span><span class="p">)</span>
                    <span class="n">varheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME&#39;</span><span class="p">,</span> <span class="s">&#39;VAR&#39;</span><span class="p">,</span> 
                                     <span class="s">&#39;Extension Name&#39;</span><span class="p">)</span>
                    <span class="n">varheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTVER&#39;</span><span class="p">,</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">(),</span> 
                                     <span class="s">&#39;Extension Version&#39;</span><span class="p">)</span>
                    <span class="n">varheader</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;BITPIX&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span> 
                                     <span class="s">&#39;number of bits per data pixel&#39;</span><span class="p">)</span>
                    
                    <span class="c"># Turning individual variance header and data </span>
                    <span class="c"># into one astrodata instance</span>
                    <span class="n">varAD</span> <span class="o">=</span> <span class="n">AstroData</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">varheader</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">varArray</span><span class="p">)</span>
                    
                    <span class="c"># Appending variance astrodata instance onto input one</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Appending new VAR HDU onto the file &#39;</span>
                                 <span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">adOut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varAD</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;appending VAR frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span>
                               <span class="s">&#39; complete for &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    
            <span class="c"># If VAR frames all ready existed, </span>
            <span class="c"># make a warning message in the logger</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;VAR frames all ready exist for &#39;</span><span class="o">+</span>
                             <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span>
                             <span class="s">&#39;, so addVAR will not calculate new ones&#39;</span><span class="p">)</span>    
            
            <span class="c"># Updating GEM-TLM (automatic) and ADDVAR time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;ADDVAR&#39;</span><span class="p">)</span>

            <span class="c"># renaming the output ad filename</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">outNames</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                    
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;File name updated to &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="c"># Appending to output list</span>
            <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the add_var function&#39;</span><span class="p">)</span>
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run add_var&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="adu_to_electrons"><a class="viewcode-back" href="../../../sciFunctions/function-adu_to_electrons.html#gempy.science.geminiScience.adu_to_electrons">[docs]</a><span class="k">def</span> <span class="nf">adu_to_electrons</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will convert the inputs from having pixel values in ADU to </span>
<span class="sd">    that of electrons by use of the arith &#39;toolbox&#39;.</span>
<span class="sd">    </span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>

<span class="sd">    Note: </span>
<span class="sd">    the SCI extensions of the input AstroData objects must have &#39;GAIN&#39;</span>
<span class="sd">    header key values available to multiply them by for conversion to </span>
<span class="sd">    e- units.</span>
<span class="sd">          </span>
<span class="sd">    :param adInputs: Astrodata inputs to be converted to Electron pixel units</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: </span>
<span class="sd">        String, either a single or a list of strings of same length as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: </span>
<span class="sd">        string to add on the end of the input filenames </span>
<span class="sd">        (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used., None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: </span>
<span class="sd">         verbosity setting for the log messages to screen,</span>
<span class="sd">         default is &#39;critical&#39; messages only.</span>
<span class="sd">         Note: independent of logLevel setting, all messages always go </span>
<span class="sd">         to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span>
                                      <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;adu_to_electrons&#39;</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c"># Do the work on each ad in the inputs</span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;calling ad.mult on &#39;</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="c"># mult in this primitive will multiply the SCI frames by the</span>
            <span class="c"># frame&#39;s gain, VAR frames by gain^2 (if they exist) and leave</span>
            <span class="c"># the DQ frames alone (if they exist).</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Calling ad.mult to convert pixel units from &#39;</span><span class="o">+</span>
                      <span class="s">&#39;ADU to electrons&#39;</span><span class="p">)</span>

            <span class="n">adOut</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">mult</span><span class="p">(</span><span class="n">ad</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span><span class="n">asDict</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>  
            
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;ad.mult completed converting the pixel units&#39;</span><span class="o">+</span>
                       <span class="s">&#39; to electrons&#39;</span><span class="p">)</span>  
                        
            <span class="c"># moving the filename over as mult doesn&#39;t do that</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
            
            <span class="c"># Updating SCI headers</span>
            <span class="k">for</span> <span class="n">sciExt</span> <span class="ow">in</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]:</span>
                <span class="c"># Retrieving this SCI extension&#39;s gain</span>
                <span class="n">gainorigDict</span> <span class="o">=</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">gain</span><span class="p">()</span>
                <span class="n">gainorig</span> <span class="o">=</span> <span class="n">gainorigDict</span><span class="p">[(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extname</span><span class="p">(),</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span> 
                <span class="c"># Updating this SCI extension&#39;s header keys</span>
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;GAINORIG&#39;</span><span class="p">,</span> <span class="n">gainorig</span><span class="p">,</span> 
                                   <span class="s">&#39;Gain prior to unit conversion (e-/ADU)&#39;</span><span class="p">)</span>
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;GAIN&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> 
                                  <span class="s">&#39;Physical units is electrons&#39;</span><span class="p">)</span> 
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;BUNIT&#39;</span><span class="p">,</span><span class="s">&#39;electrons&#39;</span> <span class="p">,</span> <span class="s">&#39;Physical units&#39;</span><span class="p">)</span>
                <span class="c"># Logging the changes to the header keys</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;SCI extension number &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span>
                             <span class="s">&#39; keywords updated/added:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;GAINORIG = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gainorig</span><span class="p">),</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span> <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;GAIN = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span> <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;BUNIT = &#39;</span><span class="o">+</span><span class="s">&#39;electrons&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span> <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                
            <span class="c"># Updating VAR headers if they exist (not updating any </span>
            <span class="c"># DQ headers as no changes were made to them here)  </span>
            <span class="k">for</span> <span class="n">varExt</span> <span class="ow">in</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;VAR&#39;</span><span class="p">]:</span>
                <span class="c"># Ensure there are no GAIN and GAINORIG header keys for </span>
                <span class="c"># the VAR extension. No errors are thrown if they aren&#39;t </span>
                <span class="c"># there initially, so all good not to check ahead. </span>
                <span class="k">del</span> <span class="n">varExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;GAINORIG&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">varExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;GAIN&#39;</span><span class="p">]</span>
                
                <span class="c"># Updating then logging the change to the BUNIT </span>
                <span class="c"># key in the VAR header</span>
                <span class="n">varExt</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;BUNIT&#39;</span><span class="p">,</span><span class="s">&#39;electrons squared&#39;</span> <span class="p">,</span> 
                                   <span class="s">&#39;Physical units&#39;</span><span class="p">)</span>
                <span class="c"># Logging the changes to the VAR extensions header keys</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;VAR extension number &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">varExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span>
                             <span class="s">&#39; keywords updated/added:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                              <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;BUNIT = &#39;</span><span class="o">+</span><span class="s">&#39;electrons squared&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span> <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
            
            <span class="c"># Updating GEM-TLM (automatic) and ADU2ELEC time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;ADU2ELEC&#39;</span><span class="p">)</span>

            <span class="c"># renaming the output ad filename</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">outNames</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                    
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;File name updated to &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="c"># Appending to output list</span>
            <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the adu_to_electrons function&#39;</span><span class="p">)</span>
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run </span><span class="se">\</span>
<span class="s">                                                            adu_to_electrons&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="bias_correct"><a class="viewcode-back" href="../../../sciFunctions/function-bias_correct.html#gempy.science.geminiScience.bias_correct">[docs]</a><span class="k">def</span> <span class="nf">bias_correct</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">biases</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fl_vardq</span><span class="o">=</span><span class="s">&#39;AUTO&#39;</span><span class="p">,</span> <span class="n">fl_trim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
                <span class="n">fl_over</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                    <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will subtract the biases from the inputs using the </span>
<span class="sd">    CL script gireduce.</span>
<span class="sd">    </span>
<span class="sd">    WARNING: The gireduce script used here replaces the previously </span>
<span class="sd">    calculated DQ frames with its own versions.  This may be corrected </span>
<span class="sd">    in the future by replacing the use of the gireduce</span>
<span class="sd">    with a Python routine to do the bias subtraction.</span>
<span class="sd">    </span>
<span class="sd">    NOTE: The inputs to this function MUST be prepared. </span>

<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to be bias subtracted</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param biases: The bias(es) to divide the input(s) by.</span>
<span class="sd">    :type biases: </span>
<span class="sd">        AstroData objects in a list, or a single instance.</span>
<span class="sd">        Note: If there is multiple inputs and one bias provided, then the</span>
<span class="sd">        same bias will be applied to all inputs; else the biases   </span>
<span class="sd">        list must match the length of the inputs.</span>
<span class="sd">    </span>
<span class="sd">    :param fl_vardq: Create variance and data quality frames?</span>
<span class="sd">    :type fl_vardq: </span>
<span class="sd">         Python boolean (True/False), OR string &#39;AUTO&#39; to do </span>
<span class="sd">         it automatically if there are VAR and DQ frames in the input(s).</span>
<span class="sd">    </span>
<span class="sd">    :param fl_trim: Trim the overscan region from the frames?</span>
<span class="sd">    :type fl_trim: Python boolean (True/False)</span>
<span class="sd">    </span>
<span class="sd">    :param fl_over: Subtract the overscan level from the frames?</span>
<span class="sd">    :type fl_over: Python boolean (True/False)</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length </span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                   (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: </span>
<span class="sd">          verbosity setting for the log messages to screen,</span>
<span class="sd">          default is &#39;critical&#39; messages only.</span>
<span class="sd">          Note: independent of logLevel setting, all messages always go </span>
<span class="sd">          to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;, </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span>
                                      <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;bias_correct&#39;</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
            
        <span class="c"># loading and bringing the pyraf related modules into the name-space</span>
        <span class="n">pyraf</span><span class="p">,</span> <span class="n">gemini</span><span class="p">,</span> <span class="n">yes</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">pyrafLoader</span><span class="p">()</span>
            
        <span class="c"># Performing work in a loop, so that different biases may be</span>
        <span class="c"># used for each input as gireduce only allows one bias input per run.</span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>
            
            <span class="c"># To clean up log and screen if multiple inputs</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>    
            
            <span class="c"># Converting input True/False to yes/no or detecting fl_vardq value</span>
            <span class="c"># if &#39;AUTO&#39; chosen with autoVardq in the ScienceFunctionManager</span>
            <span class="n">fl_vardq</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">autoVardq</span><span class="p">(</span><span class="n">fl_vardq</span><span class="p">)</span>
            
            <span class="c"># Setting up the processedBias correctly</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">biases</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">biases</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">processedBias</span> <span class="o">=</span> <span class="n">biases</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">biases</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">biases</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not sure if I need this check, but can&#39;t hurt</span>
                <span class="n">processedBias</span> <span class="o">=</span> <span class="n">biases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processedBias</span> <span class="o">=</span> <span class="n">biases</span>
                
            
            <span class="c"># Preparing input files, lists, parameters... for input to </span>
            <span class="c"># the CL script</span>
            <span class="n">clm</span><span class="o">=</span><span class="n">gemt</span><span class="o">.</span><span class="n">CLManager</span><span class="p">(</span><span class="n">imageIns</span><span class="o">=</span><span class="n">ad</span><span class="p">,</span> <span class="n">imageOutsNames</span><span class="o">=</span><span class="n">outNames</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> 
                               <span class="n">refIns</span><span class="o">=</span><span class="n">processedBias</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>  
                               <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;biasCorrect&#39;</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> 
                               <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="n">noLogFile</span><span class="p">)</span>
            
            <span class="c"># Check the status of the CLManager object, True=continue, False= issue warning</span>
            <span class="k">if</span> <span class="n">clm</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>               
                    
                <span class="c"># Parameters set by the gemt.CLManager or the definition of the function </span>
                <span class="n">clPrimParams</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s">&#39;inimages&#39;</span>    <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span>
                  <span class="s">&#39;gp_outpref&#39;</span>  <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span>
                  <span class="s">&#39;outimages&#39;</span>   <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageOutsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span>
                  <span class="c"># This returns a unique/temp log file for IRAF </span>
                  <span class="s">&#39;logfile&#39;</span>     <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">templog</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>     
                  <span class="s">&#39;fl_bias&#39;</span>     <span class="p">:</span><span class="n">yes</span><span class="p">,</span>
                  <span class="c"># Possibly add this to the params file so the user can override</span>
                  <span class="c"># this input file</span>
                  <span class="s">&#39;bias&#39;</span>        <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">refInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span>   
                  <span class="c"># This is actually in the default dict but wanted to show it again  </span>
                  <span class="s">&#39;Stdout&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                                 <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span> 
                  <span class="c"># This is actually in the default dict but wanted to show it again</span>
                  <span class="s">&#39;Stderr&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                                 <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span> 
                  <span class="c"># This is actually in the default dict but wanted to show it again</span>
                  <span class="s">&#39;verbose&#39;</span>     <span class="p">:</span><span class="n">yes</span>                
                              <span class="p">}</span>
                    
                <span class="c"># Parameters from the Parameter file adjustable by the user</span>
                <span class="n">clSoftcodedParams</span> <span class="o">=</span> <span class="p">{</span>
                   <span class="c"># pyrafBoolean converts the python booleans to pyraf ones</span>
                   <span class="s">&#39;fl_trim&#39;</span>    <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_trim</span><span class="p">),</span>
                   <span class="s">&#39;outpref&#39;</span>    <span class="p">:</span><span class="n">suffix</span><span class="p">,</span>
                   <span class="s">&#39;fl_over&#39;</span>    <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_over</span><span class="p">),</span>
                   <span class="s">&#39;fl_vardq&#39;</span>   <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_vardq</span><span class="p">)</span>
                                   <span class="p">}</span>
                <span class="c"># Grabbing the default params dict and updating it </span>
                <span class="c"># with the two above dicts</span>
                <span class="n">clParamsDict</span> <span class="o">=</span> <span class="n">CLDefaultParamsDict</span><span class="p">(</span><span class="s">&#39;gireduce&#39;</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
                <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">)</span>
                <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">)</span>
            
                <span class="c"># Logging the parameters that were not defaults</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters set automatically:&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
                <span class="c"># Loop through the parameters in the clPrimParams dictionary</span>
                <span class="c"># and log them</span>
                <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> 
                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
                
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters adjustable by the user:&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
                <span class="c"># Loop through the parameters in the clSoftcodedParams </span>
                <span class="c"># dictionary and log them</span>
                <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
                
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;calling the gireduce CL script for inputs &#39;</span><span class="o">+</span>
                                        <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
            
                <span class="n">gemini</span><span class="o">.</span><span class="n">gmos</span><span class="o">.</span><span class="n">gireduce</span><span class="p">(</span><span class="o">**</span><span class="n">clParamsDict</span><span class="p">)</span>
        
                <span class="k">if</span> <span class="n">gemini</span><span class="o">.</span><span class="n">gmos</span><span class="o">.</span><span class="n">gireduce</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;gireduce failed for inputs &#39;</span><span class="o">+</span>
                                 <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Exited the gireduce CL script successfully&#39;</span><span class="p">)</span>
                    
                <span class="c"># Renaming CL outputs and loading them back into memory </span>
                <span class="c"># and cleaning up the intermediate temp files written to disk</span>
                <span class="c"># refOuts and arrayOuts are None here</span>
                <span class="n">imageOuts</span><span class="p">,</span> <span class="n">refOuts</span><span class="p">,</span> <span class="n">arrayOuts</span> <span class="o">=</span> <span class="n">clm</span><span class="o">.</span><span class="n">finishCL</span><span class="p">()</span> 
                
                <span class="c"># There is only one at this point so no need to perform a loop</span>
                <span class="c"># CLmanager outputs a list always, so take the 0th</span>
                <span class="n">adOut</span> <span class="o">=</span> <span class="n">imageOuts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="c"># Varifying gireduce was actually ran on the file</span>
                <span class="c"># then logging file names of successfully reduced files</span>
                <span class="k">if</span> <span class="n">adOut</span><span class="o">.</span><span class="n">phuGetKeyValue</span><span class="p">(</span><span class="s">&#39;GIREDUCE&#39;</span><span class="p">):</span> 
                    <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">File &#39;</span><span class="o">+</span><span class="n">clm</span><span class="o">.</span><span class="n">preCLimageNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span>
                                 <span class="s">&#39; was bias subracted successfully&#39;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;New file name is: &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
  
                <span class="c"># Updating GEM-TLM (automatic) and BIASCORR time stamps to the PHU</span>
                <span class="c"># and updating logger with updated/added time stamps</span>
                <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;BIASCORR&#39;</span><span class="p">)</span>

                <span class="c"># Reseting the value set by gireduce to just the filename</span>
                <span class="c"># for clarity</span>
                <span class="n">adOut</span><span class="o">.</span><span class="n">phuSetKeyValue</span><span class="p">(</span><span class="s">&#39;BIASIM&#39;</span><span class="p">,</span> 
                                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">processedBias</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span> 
                
                <span class="c"># Updating log with new BIASIM header key</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;Another PHU keywords added:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;BIASIM = &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">phuGetKeyValue</span><span class="p">(</span><span class="s">&#39;BIASIM&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
           
                <span class="c"># Appending to output list</span>
                <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;One of the inputs has not been prepared,</span><span class="se">\</span>
<span class="s">                the combine function can only work on prepared data.&#39;</span><span class="p">)</span>
            
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;The CL script gireduce REPLACED the previously &#39;</span><span class="o">+</span>
                    <span class="s">&#39;calculated DQ frames&#39;</span><span class="p">)</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the bias_correct function&#39;</span><span class="p">)</span>
        
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run bias_correct&#39;</span><span class="p">)</span>     
    </div>
<div class="viewcode-block" id="combine"><a class="viewcode-back" href="../../../sciFunctions/function-combine.html#gempy.science.geminiScience.combine">[docs]</a><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">fl_vardq</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fl_dqprop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;average&#39;</span><span class="p">,</span> 
            <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span>
                                                <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will average and combine the SCI extensions of the </span>
<span class="sd">    inputs. It takes all the inputs and creates a list of them and </span>
<span class="sd">    then combines each of their SCI extensions together to create </span>
<span class="sd">    average combination file. New VAR frames are made from these </span>
<span class="sd">    combined SCI frames and the DQ frames are propagated through </span>
<span class="sd">    to the final file.</span>
<span class="sd">    NOTE: The inputs to this function MUST be prepared. </span>

<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to be combined</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param fl_vardq: Create variance and data quality frames?</span>
<span class="sd">    :type fl_vardq: Python boolean (True/False), OR string &#39;AUTO&#39; to do </span>
<span class="sd">                    it automatically if there are VAR and DQ frames in the </span>
<span class="sd">                    inputs. NOTE: &#39;AUTO&#39; uses the first input to determine if </span>
<span class="sd">                    VAR and DQ frames exist, so, if the first does, then the </span>
<span class="sd">                    rest MUST also have them as well.</span>
<span class="sd">    </span>
<span class="sd">    :param fl_dqprop: propogate the current DQ values?</span>
<span class="sd">    :type fl_dqprop: Python boolean (True/False)</span>
<span class="sd">    </span>
<span class="sd">    :param method: type of combining method to use.</span>
<span class="sd">    :type method: string, options: &#39;average&#39;, &#39;median&#39;.</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length</span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                    (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                    default is &#39;critical&#39; messages only.</span>
<span class="sd">                    Note: independent of logLevel setting, all messages always  </span>
<span class="sd">                    go to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                       <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;combine&#39;</span><span class="p">,</span> 
                                       <span class="n">combinedInputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Ensuring there is more than one input to combine</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adInputs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c"># loading and bringing the pyraf related modules into the name-space</span>
            <span class="n">pyraf</span><span class="p">,</span> <span class="n">gemini</span><span class="p">,</span> <span class="n">yes</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">pyrafLoader</span><span class="p">()</span>
            
            <span class="c"># Converting input True/False to yes/no or detecting fl_vardq value</span>
            <span class="c"># if &#39;AUTO&#39; chosen with autoVardq in the ScienceFunctionManager</span>
            <span class="n">fl_vardq</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">autoVardq</span><span class="p">(</span><span class="n">fl_vardq</span><span class="p">)</span>
                
            <span class="c"># Preparing input files, lists, parameters... for input to </span>
            <span class="c"># the CL script</span>
            <span class="n">clm</span><span class="o">=</span><span class="n">gemt</span><span class="o">.</span><span class="n">CLManager</span><span class="p">(</span><span class="n">imageIns</span><span class="o">=</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">imageOutsNames</span><span class="o">=</span><span class="n">outNames</span><span class="p">,</span> 
                               <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;combine&#39;</span><span class="p">,</span> 
                               <span class="n">combinedImages</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>  
                               <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="n">noLogFile</span><span class="p">)</span>
            
            <span class="c"># Check the status of the CLManager object, True=continue, False= issue warning</span>
            <span class="k">if</span> <span class="n">clm</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            
                <span class="c"># Creating a dictionary of the parameters set by the CLManager  </span>
                <span class="c"># or the definition of the primitive </span>
                <span class="n">clPrimParams</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c"># Retrieving the inputs as a list from the CLManager</span>
                    <span class="s">&#39;input&#39;</span>       <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;listFile&#39;</span><span class="p">),</span>
                    <span class="c"># Maybe allow the user to override this in the future. </span>
                    <span class="s">&#39;output&#39;</span>      <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageOutsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span> 
                    <span class="c"># This returns a unique/temp log file for IRAF  </span>
                    <span class="s">&#39;logfile&#39;</span>     <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">templog</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  
                    <span class="c"># This is actually in the default dict but wanted to </span>
                    <span class="c"># show it again       </span>
                    <span class="s">&#39;Stdout&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span> 
                    <span class="c"># This is actually in the default dict but wanted to </span>
                    <span class="c"># show it again    </span>
                    <span class="s">&#39;Stderr&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span>
                    <span class="c"># This is actually in the default dict but wanted to </span>
                    <span class="c"># show it again     </span>
                    <span class="s">&#39;verbose&#39;</span>     <span class="p">:</span><span class="n">yes</span><span class="p">,</span>    
                    <span class="s">&#39;reject&#39;</span>      <span class="p">:</span><span class="s">&#39;none&#39;</span>                
                              <span class="p">}</span>
                
                <span class="c"># Creating a dictionary of the parameters from the Parameter </span>
                <span class="c"># file adjustable by the user</span>
                <span class="n">clSoftcodedParams</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;fl_vardq&#39;</span>      <span class="p">:</span><span class="n">fl_vardq</span><span class="p">,</span>
                    <span class="c"># pyrafBoolean converts the python booleans to pyraf ones</span>
                    <span class="s">&#39;fl_dqprop&#39;</span>     <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_dqprop</span><span class="p">),</span>
                    <span class="s">&#39;combine&#39;</span>       <span class="p">:</span><span class="n">method</span><span class="p">,</span>
                                    <span class="p">}</span>
                <span class="c"># Grabbing the default parameters dictionary and updating </span>
                <span class="c"># it with the two above dictionaries</span>
                <span class="n">clParamsDict</span> <span class="o">=</span> <span class="n">CLDefaultParamsDict</span><span class="p">(</span><span class="s">&#39;gemcombine&#39;</span><span class="p">,</span> 
                                                   <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
                <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">)</span>
                <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">)</span>
                
                <span class="c"># Logging the parameters that were not defaults</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters set automatically:&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
                <span class="c"># Loop through the parameters in the clPrimParams dictionary</span>
                <span class="c"># and log them</span>
                <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> 
                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
                
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters adjustable by the user:&#39;</span><span class="p">,</span> 
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
                <span class="c"># Loop through the parameters in the clSoftcodedParams dictionary</span>
                <span class="c"># and log them</span>
                <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> 
                                   <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
                
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Calling the gemcombine CL script for input</span><span class="se">\</span>
<span class="s">                                 list &#39;</span><span class="o">+</span><span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;listFile&#39;</span><span class="p">))</span>
                
                <span class="n">gemini</span><span class="o">.</span><span class="n">gemcombine</span><span class="p">(</span><span class="o">**</span><span class="n">clParamsDict</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">gemini</span><span class="o">.</span><span class="n">gemcombine</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;gemcombine failed for inputs &#39;</span><span class="o">+</span>
                                 <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Exited the gemcombine CL script </span><span class="se">\</span>
<span class="s">                                                            successfully&#39;</span><span class="p">)</span>
                
                <span class="c"># Renaming CL outputs and loading them back into memory </span>
                <span class="c"># and cleaning up the intermediate temp files written to disk</span>
                <span class="c"># refOuts and arrayOuts are None here</span>
                <span class="n">imageOuts</span><span class="p">,</span> <span class="n">refOuts</span><span class="p">,</span> <span class="n">arrayOuts</span> <span class="o">=</span> <span class="n">clm</span><span class="o">.</span><span class="n">finishCL</span><span class="p">()</span> 
            
                <span class="c"># Renaming for symmetry</span>
                <span class="n">adOutputs</span><span class="o">=</span><span class="n">imageOuts</span>
                
                <span class="c"># Updating GEM-TLM (automatic) and COMBINE time stamps to the PHU</span>
                <span class="c"># and updating logger with updated/added time stamps</span>
                <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOutputs</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;COMBINE&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;One of the inputs has not been prepared,</span><span class="se">\</span>
<span class="s">                the combine function can only work on prepared data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Only one input was passed in for adInputs, so combine </span><span class="se">\</span>
<span class="s">                    is simply passing the inputs into the outputs list without </span><span class="se">\</span>
<span class="s">                    doing anything to them.&#39;</span><span class="p">)</span>
            <span class="n">adOutputs</span> <span class="o">=</span> <span class="n">adInputs</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the combine function&#39;</span><span class="p">)</span>
        
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run combine&#39;</span><span class="p">)</span>
                </div>
<div class="viewcode-block" id="flat_correct"><a class="viewcode-back" href="../../../GEMINI_user_level_functions.html#gempy.science.geminiScience.flat_correct">[docs]</a><span class="k">def</span> <span class="nf">flat_correct</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">flats</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                            <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs a flat correction by dividing the inputs by  </span>
<span class="sd">    processed flats, similar to the way gireduce would perform this operation</span>
<span class="sd">    but written in pure python in the arith toolbox.</span>
<span class="sd">    </span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to have DQ extensions added to</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param flats: The flat(s) to divide the input(s) by.</span>
<span class="sd">    :type flats: AstroData objects in a list, or a single instance.</span>
<span class="sd">                Note: If there is multiple inputs and one flat provided, then the</span>
<span class="sd">                same flat will be applied to all inputs; else the flats   </span>
<span class="sd">                list must match the length of the inputs.</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length </span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                    (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                    default is &#39;critical&#39; messages only.</span>
<span class="sd">                    Note: independent of logLevel setting, all messages always </span>
<span class="sd">                    go to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> 
                                      <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;flat_correct&#39;</span><span class="p">)</span> 
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">flats</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;There must be at least one processed flat provided,</span><span class="se">\</span>
<span class="s">                             the &quot;flats&quot; parameter must not be None.&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c"># Loop through the inputs to perform the non-linear and saturated</span>
        <span class="c"># pixel searches of the SCI frames to update the BPM frames into</span>
        <span class="c"># full DQ frames. </span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>                   
            <span class="c"># To clean up log and screen if multiple inputs</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>    

            <span class="c"># Getting the right flat for this input</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">processedFlat</span> <span class="o">=</span> <span class="n">flats</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">processedFlat</span> <span class="o">=</span> <span class="n">flats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processedFlat</span> <span class="o">=</span> <span class="n">flats</span>

            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Input flat file being used for flat correction &#39;</span>
                       <span class="o">+</span><span class="n">processedFlat</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Calling ad.div on &#39;</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="n">adOut</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">processedFlat</span><span class="p">)</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;ad.div successfully flat corrected &#39;</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>   
            
            <span class="c"># Updating GEM-TLM (automatic) and BIASCORR time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;FLATCORR&#39;</span><span class="p">)</span>
            
            <span class="c"># renaming the output ad filename</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">outNames</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                    
            <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;File name updated to &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        
            <span class="c"># Appending to output list</span>
            <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

            <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the flat_correct function&#39;</span><span class="p">)</span>
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run flat_correct&#39;</span><span class="p">)</span>
                </div>
<div class="viewcode-block" id="measure_iq"><a class="viewcode-back" href="../../../sciFunctions/function-measure_iq.html#gempy.science.geminiScience.measure_iq">[docs]</a><span class="k">def</span> <span class="nf">measure_iq</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">qa</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">keepDats</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will detect the sources in the input images and fit</span>
<span class="sd">    both Gaussian and Moffat models to their profiles and calculate the </span>
<span class="sd">    Image Quality and seeing from this.</span>
<span class="sd">    </span>
<span class="sd">    Since the resultant parameters are formatted into one nice string and </span>
<span class="sd">    normally recorded in a logger message, the returned dictionary of these </span>
<span class="sd">    parameters may be ignored. BUT, if the user wishes to completely shut off</span>
<span class="sd">    the logging, then the returned dictionary of the results can be useful.</span>
<span class="sd">    The dictionary&#39;s format is:</span>
<span class="sd">    {adIn1.filename:formatted results string for adIn1, </span>
<span class="sd">    adIn2.filename:formatted results string for adIn2,...}</span>
<span class="sd">    </span>
<span class="sd">    There are also .dat files that result from this function written to the </span>
<span class="sd">    current working directory under the names &#39;measure_iq&#39;+adIn.filename+&#39;.dat&#39;.</span>
<span class="sd">    ex: input filename &#39;N20100311S0090.fits&#39;, </span>
<span class="sd">    .dat filename &#39;measure_iqN20100311S0090.dat&#39;</span>
<span class="sd">    </span>
<span class="sd">    NOTE:</span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    Warning:</span>
<span class="sd">    ALL inputs of adInputs must have either 1 SCI extension, indicating they </span>
<span class="sd">    have been mosaic&#39;d, or 3 like a normal un-mosaic&#39;d GMOS image.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to have their image quality measured</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param function: Function for centroid fitting</span>
<span class="sd">    :type function: string, can be: &#39;moffat&#39;,&#39;gauss&#39; or &#39;both&#39;; </span>
<span class="sd">                    Default &#39;both&#39;</span>
<span class="sd">                    </span>
<span class="sd">    :param display: Flag to turn on displaying the fitting to ds9</span>
<span class="sd">    :type display: Python boolean (True/False)</span>
<span class="sd">                   Default: True</span>
<span class="sd">                  </span>
<span class="sd">    :param qa: flag to use a grid of sub-windows for detecting the sources in </span>
<span class="sd">               the image frames, rather than the entire frame all at once.</span>
<span class="sd">    :type qa: Python boolean (True/False)</span>
<span class="sd">              default: True</span>
<span class="sd">    </span>
<span class="sd">    :param keepDats: flag to keep the .dat files that provide detailed results </span>
<span class="sd">                     found while measuring the input&#39;s image quality.</span>
<span class="sd">    :type keepDats: Python boolean (True/False)</span>
<span class="sd">                    default: False</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length</span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                    (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                     default is &#39;critical&#39; messages only.</span>
<span class="sd">                     Note: independent of logLevel setting, all messages always </span>
<span class="sd">                     go to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> 
                                      <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;measure_iq&#39;</span><span class="p">)</span> 
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="c"># NOTE: outNames are not needed, but sfm.startUp creates them automatically.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Importing getiq module to perform the source detection and IQ</span>
        <span class="c"># measurements of the inputs</span>
        <span class="kn">from</span> <span class="nn">iqtool.iq</span> <span class="kn">import</span> <span class="n">getiq</span>
        
        <span class="c"># Initializing a total time sum variable for logging purposes </span>
        <span class="n">total_IQ_time</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c"># Creating dictionary for output strings to be returned in</span>
        <span class="n">outDict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c"># Loop through the inputs to perform the non-linear and saturated</span>
        <span class="c"># pixel searches of the SCI frames to update the BPM frames into</span>
        <span class="c"># full DQ frames. </span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>                     
            <span class="c"># Writing the input to disk under a temp name in the current </span>
            <span class="c"># working directory for getiq to use to be deleted after getiq</span>
            <span class="n">tmpWriteName</span> <span class="o">=</span> <span class="s">&#39;measure_iq&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;The inputs to measureIQ must be in the&#39;</span><span class="o">+</span>
                         <span class="s">&#39; current working directory for it to work &#39;</span><span class="o">+</span>\
                         <span class="s">&#39;correctly, so writting it temperarily to file &#39;</span><span class="o">+</span>
                         <span class="n">tmpWriteName</span><span class="p">)</span>
            <span class="n">ad</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmpWriteName</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
            <span class="c"># Automatically determine the &#39;mosaic&#39; parameter for gemiq</span>
            <span class="c"># if there are 3 SCI extensions -&gt; mosaic=False</span>
            <span class="c"># if only one -&gt; mosaic=True, else raise error</span>
            <span class="n">numExts</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">countExts</span><span class="p">(</span><span class="s">&#39;SCI&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">numExts</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">mosaic</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">numExts</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">mosaic</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;The input &#39;</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39; had &#39;</span><span class="o">+</span>\
                                   <span class="nb">str</span><span class="p">(</span><span class="n">numExts</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; SCI extensions and inputs </span><span class="se">\</span>
<span class="s">                                   with only 1 or 3 extensions are allowed&#39;</span><span class="p">)</span>
            
            <span class="c"># Start time for measuring IQ of current file</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Calling getiq.gemiq for input &#39;</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            
            <span class="c"># Calling the gemiq function to detect the sources and then</span>
            <span class="c"># measure the IQ of the current image </span>
            <span class="n">iqdata</span> <span class="o">=</span> <span class="n">getiq</span><span class="o">.</span><span class="n">gemiq</span><span class="p">(</span><span class="n">tmpWriteName</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">,</span> 
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">,</span> 
                                  <span class="n">mosaic</span><span class="o">=</span><span class="n">mosaic</span><span class="p">,</span> <span class="n">qa</span><span class="o">=</span><span class="n">qa</span><span class="p">)</span>
            
            <span class="c"># End time for measuring IQ of current file</span>
            <span class="n">et</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">total_IQ_time</span> <span class="o">=</span> <span class="n">total_IQ_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">et</span> <span class="o">-</span> <span class="n">st</span><span class="p">)</span>
            <span class="c"># Logging the amount of time spent measuring the IQ </span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;MeasureIQ time: &#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">et</span> <span class="o">-</span> <span class="n">st</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;IQ&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="o">*</span><span class="mi">45</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>
            
            <span class="c"># If input was writen to temp file on disk, delete it</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmpWriteName</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpWriteName</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;The temporarily written to disk file, &#39;</span><span class="o">+</span>
                             <span class="n">tmpWriteName</span><span class="o">+</span> <span class="s">&#39;, was removed from disk.&#39;</span><span class="p">)</span>
            
            <span class="c"># Deleting the .dat file from disk if requested</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keepDats</span><span class="p">:</span>
                <span class="n">datName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">tmpWriteName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.dat&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">datName</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;The temporarily written to disk file, &#39;</span><span class="o">+</span>
                             <span class="n">datName</span><span class="o">+</span> <span class="s">&#39;, was removed from disk.&#39;</span><span class="p">)</span>
                
            <span class="c"># iqdata is list of tuples with image quality metrics</span>
            <span class="c"># (ellMean, ellSig, fwhmMean, fwhmSig)</span>
            <span class="c"># First check if it is empty (ie. gemiq failed in someway)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iqdata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Problem Measuring IQ Statistics, &#39;</span><span class="o">+</span>
                            <span class="s">&#39;none reported&#39;</span><span class="p">)</span>
            <span class="c"># If it all worked, then format the output and log it</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Formatting this output for printing or logging                </span>
                <span class="n">fnStr</span> <span class="o">=</span> <span class="s">&#39;Filename:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
                <span class="n">emStr</span> <span class="o">=</span> <span class="s">&#39;Ellipticity Mean:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">esStr</span> <span class="o">=</span> <span class="s">&#39;Ellipticity Sigma:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">fmStr</span> <span class="o">=</span> <span class="s">&#39;FWHM Mean:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">fsStr</span> <span class="o">=</span> <span class="s">&#39;FWHM Sigma:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">sStr</span> <span class="o">=</span> <span class="s">&#39;Seeing:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iqdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">psStr</span> <span class="o">=</span> <span class="s">&#39;PixelScale:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">()[(</span><span class="s">&#39;SCI&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)])</span>
                <span class="n">vStr</span> <span class="o">=</span> <span class="s">&#39;VERSION:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;None&#39;</span> <span class="c">#$$$$$ made on ln12 of ReductionsObjectRequest.py, always &#39;None&#39; it seems.</span>
                <span class="n">tStr</span> <span class="o">=</span> <span class="s">&#39;TIMESTAMP:&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="c"># Create final formated string</span>
                <span class="n">finalStr</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">45</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">fnStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">emStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">esStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>\
                                <span class="o">+</span><span class="n">fmStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">fsStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">sStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">psStr</span><span class="o">+</span>\
                                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">vStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">tStr</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">45</span>
                <span class="c"># Log final string</span>
                <span class="n">log</span><span class="o">.</span><span class="n">stdinfo</span><span class="p">(</span><span class="n">finalStr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;IQ&#39;</span><span class="p">)</span>
                
                <span class="c"># appending formated string to the output dictionary</span>
                <span class="n">outDict</span><span class="p">[</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">finalStr</span>
                
        <span class="c"># Logging the total amount of time spent measuring the IQ of all</span>
        <span class="c"># the inputs</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Total measureIQ time: &#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">total_IQ_time</span><span class="p">),</span> 
                    <span class="n">category</span><span class="o">=</span><span class="s">&#39;IQ&#39;</span><span class="p">)</span>
        
        <span class="c">#returning complete dictionary for use by the user if desired</span>
        <span class="k">return</span> <span class="n">outDict</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="c">#ScienceError(&#39;An error occurred while trying to run measure_iq&#39;)                              </span>
                </div>
<div class="viewcode-block" id="mosaic_detectors"><a class="viewcode-back" href="../../../sciFunctions/function-mosaic_detectors.html#gempy.science.geminiScience.mosaic_detectors">[docs]</a><span class="k">def</span> <span class="nf">mosaic_detectors</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">fl_paste</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">interp_function</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span>  
                <span class="n">fl_vardq</span><span class="o">=</span><span class="s">&#39;AUTO&#39;</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will mosaic the SCI frames of the input images, </span>
<span class="sd">    along with the VAR and DQ frames if they exist.  </span>
<span class="sd">    </span>
<span class="sd">    WARNING: The gmosaic script used here replaces the previously </span>
<span class="sd">    calculated DQ frames with its own versions.  This may be corrected </span>
<span class="sd">    in the future by replacing the use of the gmosaic</span>
<span class="sd">    with a Python routine to do the frame mosaicing.</span>
<span class="sd">    </span>
<span class="sd">    NOTE: The inputs to this function MUST be prepared. </span>

<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to mosaic the extensions of</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param fl_paste: Paste images instead of mosaic?</span>
<span class="sd">    :type fl_paste: Python boolean (True/False)</span>
<span class="sd">    </span>
<span class="sd">    :param interp_function: type of interpolation algorithm to use for between </span>
<span class="sd">                            the chip gaps.</span>
<span class="sd">    :type interp_function: string, options: &#39;linear&#39;, &#39;nearest&#39;, &#39;poly3&#39;, </span>
<span class="sd">                           &#39;poly5&#39;, &#39;spine3&#39;, &#39;sinc&#39;.</span>
<span class="sd">    </span>
<span class="sd">    :param fl_vardq: Also mosaic VAR and DQ frames?</span>
<span class="sd">    :type fl_vardq: Python boolean (True/False), OR string &#39;AUTO&#39; to do </span>
<span class="sd">                    it automatically if there are VAR and DQ frames in the </span>
<span class="sd">                    inputs.</span>
<span class="sd">                    NOTE: &#39;AUTO&#39; uses the first input to determine if VAR and  </span>
<span class="sd">                    DQ frames exist, so, if the first does, then the rest MUST </span>
<span class="sd">                    also have them as well.</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length </span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                    (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                    default is &#39;critical&#39; messages only.</span>
<span class="sd">                    Note: independent of logLevel setting, all messages always  </span>
<span class="sd">                    go to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;, </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> 
                                      <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;mosaic_detectors&#39;</span><span class="p">)</span> 
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># loading and bringing the pyraf related modules into the name-space</span>
        <span class="n">pyraf</span><span class="p">,</span> <span class="n">gemini</span><span class="p">,</span> <span class="n">yes</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">pyrafLoader</span><span class="p">()</span>  
            
        <span class="c"># Converting input True/False to yes/no or detecting fl_vardq value</span>
        <span class="c"># if &#39;AUTO&#39; chosen with autoVardq in the ScienceFunctionManager</span>
        <span class="n">fl_vardq</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">autoVardq</span><span class="p">(</span><span class="n">fl_vardq</span><span class="p">)</span>
        
        <span class="c"># To clean up log and screen if multiple inputs</span>
        <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>    
        
        <span class="c"># Preparing input files, lists, parameters... for input to </span>
        <span class="c"># the CL script</span>
        <span class="n">clm</span><span class="o">=</span><span class="n">gemt</span><span class="o">.</span><span class="n">CLManager</span><span class="p">(</span><span class="n">imageIns</span><span class="o">=</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">imageOutsNames</span><span class="o">=</span><span class="n">outNames</span><span class="p">,</span> 
                           <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;mosaicDetectors&#39;</span><span class="p">,</span>  
                           <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">,</span> 
                           <span class="n">noLogFile</span><span class="o">=</span><span class="n">noLogFile</span><span class="p">)</span>
        
        <span class="c"># Check the status of the CLManager object, True=continue, False= issue warning</span>
        <span class="k">if</span> <span class="n">clm</span><span class="o">.</span><span class="n">status</span><span class="p">:</span> 
            <span class="c"># Parameters set by the gemt.CLManager or the definition of the prim </span>
            <span class="n">clPrimParams</span> <span class="o">=</span> <span class="p">{</span>
              <span class="c"># Retrieving the inputs as a string of filenames</span>
              <span class="s">&#39;inimages&#39;</span>    <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span>
              <span class="s">&#39;outimages&#39;</span>   <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageOutsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span>
              <span class="c"># Setting the value of FL_vardq set above</span>
              <span class="s">&#39;fl_vardq&#39;</span>    <span class="p">:</span><span class="n">fl_vardq</span><span class="p">,</span>
              <span class="c"># This returns a unique/temp log file for IRAF </span>
              <span class="s">&#39;logfile&#39;</span>     <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">templog</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="c"># This is actually in the default dict but wanted to show it again     </span>
              <span class="s">&#39;Stdout&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span><span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span> 
              <span class="c"># This is actually in the default dict but wanted to show it again</span>
              <span class="s">&#39;Stderr&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span><span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span> 
              <span class="c"># This is actually in the default dict but wanted to show it again</span>
              <span class="s">&#39;verbose&#39;</span>     <span class="p">:</span><span class="n">yes</span>                
                          <span class="p">}</span>
            <span class="c"># Parameters from the Parameter file adjustable by the user</span>
            <span class="n">clSoftcodedParams</span> <span class="o">=</span> <span class="p">{</span>
              <span class="c"># pyrafBoolean converts the python booleans to pyraf ones</span>
              <span class="s">&#39;fl_paste&#39;</span>    <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_paste</span><span class="p">),</span>
              <span class="s">&#39;outpref&#39;</span>     <span class="p">:</span><span class="n">suffix</span><span class="p">,</span>
              <span class="s">&#39;geointer&#39;</span>    <span class="p">:</span><span class="n">interp_function</span><span class="p">,</span>
                              <span class="p">}</span>
            <span class="c"># Grabbing the default params dict and updating it with </span>
            <span class="c"># the two above dicts</span>
            <span class="n">clParamsDict</span> <span class="o">=</span> <span class="n">CLDefaultParamsDict</span><span class="p">(</span><span class="s">&#39;gmosaic&#39;</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                               <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
            <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">)</span>
            <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">)</span>      
                
            <span class="c"># Logging the parameters that were not defaults</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters set automatically:&#39;</span><span class="p">,</span> 
                         <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
            <span class="c"># Loop through the parameters in the clPrimParams dictionary</span>
            <span class="c"># and log them</span>
            <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters adjustable by the user:&#39;</span><span class="p">,</span> 
                         <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
            <span class="c"># Loop through the parameters in the clSoftcodedParams </span>
            <span class="c"># dictionary and log them</span>
            <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                               <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;calling the gmosaic CL script for inputs &#39;</span><span class="o">+</span>
                                        <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
        
            <span class="n">gemini</span><span class="o">.</span><span class="n">gmos</span><span class="o">.</span><span class="n">gmosaic</span><span class="p">(</span><span class="o">**</span><span class="n">clParamsDict</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="n">gemini</span><span class="o">.</span><span class="n">gmos</span><span class="o">.</span><span class="n">gmosaic</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;gireduce failed for inputs &#39;</span><span class="o">+</span>
                             <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Exited the gmosaic CL script successfully&#39;</span><span class="p">)</span>    
                
                
            <span class="c"># Renaming CL outputs and loading them back into memory </span>
            <span class="c"># and cleaning up the intermediate temp files written to disk</span>
            <span class="c"># refOuts and arrayOuts are None here</span>
            <span class="n">imageOuts</span><span class="p">,</span> <span class="n">refOuts</span><span class="p">,</span> <span class="n">arrayOuts</span> <span class="o">=</span> <span class="n">clm</span><span class="o">.</span><span class="n">finishCL</span><span class="p">()</span>   
            
            <span class="c"># Renaming for symmetry</span>
            <span class="n">adOutputs</span><span class="o">=</span><span class="n">imageOuts</span>
                
            <span class="c"># Wrap up logging</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adOutputs</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                
                <span class="c"># Varifying gireduce was actually ran on the file</span>
                <span class="c"># then logging file names of successfully reduced files</span>
                <span class="k">if</span> <span class="n">ad</span><span class="o">.</span><span class="n">phuGetKeyValue</span><span class="p">(</span><span class="s">&#39;GMOSAIC&#39;</span><span class="p">):</span> 
                    <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">File &#39;</span><span class="o">+</span><span class="n">clm</span><span class="o">.</span><span class="n">preCLimageNames</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span>\
                                 <span class="s">&#39; mosaiced successfully&#39;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;New file name is: &#39;</span><span class="o">+</span><span class="n">ad</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>

                <span class="c"># Updating GEM-TLM (automatic) and BIASCORR time stamps to the PHU</span>
                <span class="c"># and updating logger with updated/added time stamps</span>
                <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">ad</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;MOSAIC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;One of the inputs has not been prepared, the</span><span class="se">\</span>
<span class="s">             mosaicDetectors function can only work on prepared data.&#39;</span><span class="p">)</span>
                
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the mosaic_detectors function&#39;</span><span class="p">)</span>
        
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run </span><span class="se">\</span>
<span class="s">                                                            mosaic_detectors&#39;</span><span class="p">)</span> 
                </div>
<div class="viewcode-block" id="normalize_flat"><a class="viewcode-back" href="../../../sciFunctions/function-normalize_flat.html#gempy.science.geminiScience.normalize_flat">[docs]</a><span class="k">def</span> <span class="nf">normalize_flat</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">fl_trim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fl_over</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fl_vardq</span><span class="o">=</span><span class="s">&#39;AUTO&#39;</span><span class="p">,</span> 
                <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span>  
                <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will combine the input flats (adInputs) and then normalize  </span>
<span class="sd">    them using the CL script giflat.</span>
<span class="sd">    </span>
<span class="sd">    WARNING: The giflat script used here replaces the previously </span>
<span class="sd">    calculated DQ frames with its own versions.  This may be corrected </span>
<span class="sd">    in the future by replacing the use of the giflat</span>
<span class="sd">    with a Python routine to do the flat normalizing.</span>
<span class="sd">    </span>
<span class="sd">    NOTE: The inputs to this function MUST be prepared. </span>

<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata input flat(s) to be combined and normalized</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param fl_trim: Trim the overscan region from the frames?</span>
<span class="sd">    :type fl_trim: Python boolean (True/False)</span>
<span class="sd">    </span>
<span class="sd">    :param fl_over: Subtract the overscan level from the frames?</span>
<span class="sd">    :type fl_over: Python boolean (True/False)</span>
<span class="sd">    </span>
<span class="sd">    :param fl_vardq: Create variance and data quality frames?</span>
<span class="sd">    :type fl_vardq: Python boolean (True/False), OR string &#39;AUTO&#39; to do </span>
<span class="sd">                    it automatically if there are VAR and DQ frames in the </span>
<span class="sd">                    inputs.</span>
<span class="sd">                    NOTE: &#39;AUTO&#39; uses the first input to determine if VAR and  </span>
<span class="sd">                    DQ frames exist, so, if the first does, then the rest MUST </span>
<span class="sd">                    also have them as well.</span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length </span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix:</span>
<span class="sd">            string to add on the end of the input filenames </span>
<span class="sd">            (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                    default is &#39;critical&#39; messages only.</span>
<span class="sd">                    Note: independent of logLevel setting, all messages always  </span>
<span class="sd">                    go to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                       <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span>  
                                       <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;normalize_flat&#39;</span><span class="p">,</span> 
                                       <span class="n">combinedInputs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># loading and bringing the pyraf related modules into the name-space</span>
        <span class="n">pyraf</span><span class="p">,</span> <span class="n">gemini</span><span class="p">,</span> <span class="n">yes</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">pyrafLoader</span><span class="p">()</span>  
            
        <span class="c"># Converting input True/False to yes/no or detecting fl_vardq value</span>
        <span class="c"># if &#39;AUTO&#39; chosen with autoVardq in the ScienceFunctionManager</span>
        <span class="n">fl_vardq</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">autoVardq</span><span class="p">(</span><span class="n">fl_vardq</span><span class="p">)</span>
        
        <span class="c"># To clean up log and screen if multiple inputs</span>
        <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>    
        
        <span class="c"># Preparing input files, lists, parameters... for input to </span>
        <span class="c"># the CL script</span>
        <span class="n">clm</span><span class="o">=</span><span class="n">gemt</span><span class="o">.</span><span class="n">CLManager</span><span class="p">(</span><span class="n">imageIns</span><span class="o">=</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">imageOutsNames</span><span class="o">=</span><span class="n">outNames</span><span class="p">,</span>  
                           <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;normalizeFlat&#39;</span><span class="p">,</span> 
                           <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> <span class="n">combinedImages</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                           <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="o">=</span><span class="n">noLogFile</span><span class="p">)</span>
        
        <span class="c"># Check the status of the CLManager object, True=continue, False= issue warning</span>
        <span class="k">if</span> <span class="n">clm</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>                 
            <span class="c"># Creating a dictionary of the parameters set by the gemt.CLManager </span>
            <span class="c"># or the definition of the function </span>
            <span class="n">clPrimParams</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s">&#39;inflats&#39;</span>     <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;listFile&#39;</span><span class="p">),</span>
              <span class="c"># Maybe allow the user to override this in the future</span>
              <span class="s">&#39;outflat&#39;</span>     <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">imageOutsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">),</span> 
              <span class="c"># This returns a unique/temp log file for IRAF  </span>
              <span class="s">&#39;logfile&#39;</span>     <span class="p">:</span><span class="n">clm</span><span class="o">.</span><span class="n">templog</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>         
              <span class="c"># This is actually in the default dict but wanted to show it again</span>
              <span class="s">&#39;Stdout&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span><span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span>   
              <span class="c"># This is actually in the default dict but wanted to show it again  </span>
              <span class="s">&#39;Stderr&#39;</span>      <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">IrafStdout</span><span class="p">(</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span><span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">),</span> 
              <span class="c"># This is actually in the default dict but wanted to show it again    </span>
              <span class="s">&#39;verbose&#39;</span>     <span class="p">:</span><span class="n">yes</span>                    
                          <span class="p">}</span>
            <span class="c"># Creating a dictionary of the parameters from the function call </span>
            <span class="c"># adjustable by the user</span>
            <span class="n">clSoftcodedParams</span> <span class="o">=</span> <span class="p">{</span>
               <span class="s">&#39;fl_vardq&#39;</span>   <span class="p">:</span><span class="n">fl_vardq</span><span class="p">,</span>
               <span class="s">&#39;fl_over&#39;</span>    <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_over</span><span class="p">),</span>
               <span class="s">&#39;fl_trim&#39;</span>    <span class="p">:</span><span class="n">gemt</span><span class="o">.</span><span class="n">pyrafBoolean</span><span class="p">(</span><span class="n">fl_trim</span><span class="p">)</span>
                               <span class="p">}</span>
            <span class="c"># Grabbing the default params dict and updating it </span>
            <span class="c"># with the two above dicts</span>
            <span class="n">clParamsDict</span> <span class="o">=</span> <span class="n">CLDefaultParamsDict</span><span class="p">(</span><span class="s">&#39;giflat&#39;</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span>
                                               <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
            <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">)</span>
            <span class="n">clParamsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">)</span>
            
            <span class="c"># Logging the parameters that were not defaults</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters set automatically:&#39;</span><span class="p">,</span> 
                         <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
            <span class="c"># Loop through the parameters in the clPrimParams dictionary</span>
            <span class="c"># and log them</span>
            <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clPrimParams</span><span class="p">,</span> <span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Parameters adjustable by the user:&#39;</span><span class="p">,</span> 
                         <span class="n">category</span><span class="o">=</span><span class="s">&#39;parameters&#39;</span><span class="p">)</span>
            <span class="c"># Loop through the parameters in the clSoftcodedParams </span>
            <span class="c"># dictionary and log them</span>
            <span class="n">gemt</span><span class="o">.</span><span class="n">logDictParams</span><span class="p">(</span><span class="n">clSoftcodedParams</span><span class="p">,</span><span class="n">logName</span><span class="o">=</span><span class="n">logName</span><span class="p">,</span> 
                               <span class="n">logLevel</span><span class="o">=</span><span class="n">logLevel</span><span class="p">)</span>
            
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Calling the giflat CL script for inputs list &#39;</span><span class="o">+</span>
                  <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;listFile&#39;</span><span class="p">))</span>
        
            <span class="n">gemini</span><span class="o">.</span><span class="n">giflat</span><span class="p">(</span><span class="o">**</span><span class="n">clParamsDict</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">gemini</span><span class="o">.</span><span class="n">giflat</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;giflat failed for inputs &#39;</span><span class="o">+</span>
                             <span class="n">clm</span><span class="o">.</span><span class="n">imageInsFiles</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;Exited the giflat CL script successfully&#39;</span><span class="p">)</span>
            
            <span class="c"># Renaming CL outputs and loading them back into memory </span>
            <span class="c"># and cleaning up the intermediate temp files written to disk</span>
            <span class="c"># refOuts and arrayOuts are None here</span>
            <span class="n">imageOuts</span><span class="p">,</span> <span class="n">refOuts</span><span class="p">,</span> <span class="n">arrayOuts</span> <span class="o">=</span> <span class="n">clm</span><span class="o">.</span><span class="n">finishCL</span><span class="p">()</span>
        
            <span class="c"># Renaming for symmetry</span>
            <span class="n">adOutputs</span><span class="o">=</span><span class="n">imageOuts</span>
        
            <span class="c"># Updating GEM-TLM (automatic) and COMBINE time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOutputs</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;GIFLAT&#39;</span><span class="p">)</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;One of the inputs has not been prepared,</span><span class="se">\</span>
<span class="s">            the normalizeFlat function can only work on prepared data.&#39;</span><span class="p">)</span>
                
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the normalize_flat function&#39;</span><span class="p">)</span>
        
        <span class="c"># Return the outputs (list or single, matching adInputs)</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run </span><span class="se">\</span>
<span class="s">                                                                normalize_flat&#39;</span><span class="p">)</span>    
    </div>
<div class="viewcode-block" id="overscan_trim"><a class="viewcode-back" href="../../../sciFunctions/function-overscan_trim.html#gempy.science.geminiScience.overscan_trim">[docs]</a><span class="k">def</span> <span class="nf">overscan_trim</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  
                            <span class="n">logName</span><span class="o">=</span><span class="s">&#39;gemini.log&#39;</span><span class="p">,</span> <span class="n">logLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">noLogFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function uses AstroData to trim the overscan region </span>
<span class="sd">    from the input images and update their headers.</span>
<span class="sd">    </span>
<span class="sd">    A string representing the name of the log file to write all log messages to</span>
<span class="sd">    can be defined, or a default of &#39;gemini.log&#39; will be used.  If the file</span>
<span class="sd">    all ready exists in the directory you are working in, then this file will </span>
<span class="sd">    have the log messages during this function added to the end of it.</span>
<span class="sd">    </span>
<span class="sd">    :param adInputs: Astrodata inputs to have DQ extensions added to</span>
<span class="sd">    :type adInputs: Astrodata objects, either a single or a list of objects</span>
<span class="sd">    </span>
<span class="sd">    :param outNames: filenames of output(s)</span>
<span class="sd">    :type outNames: String, either a single or a list of strings of same length</span>
<span class="sd">                    as adInputs.</span>
<span class="sd">    </span>
<span class="sd">    :param suffix: string to add on the end of the input filenames </span>
<span class="sd">                    (or outNames if not None) for the output filenames.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    </span>
<span class="sd">    :param log: logger object to send log messges to</span>
<span class="sd">    :type log: A gemLog object from astrodata/adutils/gemLog.py .</span>
<span class="sd">               It is an upgraded version of the Python logger for use </span>
<span class="sd">               with all new scripts in gemini_python/ .</span>
<span class="sd">               Note: the logName, logLevel and noLogFile will be automatically</span>
<span class="sd">               determined from the logger object passed in to &#39;log&#39; with the </span>
<span class="sd">               ScienceFunctionManager.startUp() function.</span>
<span class="sd">    </span>
<span class="sd">    :param logName: Name of the log file, default is &#39;gemini.log&#39;</span>
<span class="sd">    :type logName: String, None causes default to be used.</span>
<span class="sd">    </span>
<span class="sd">    :param logLevel: verbosity setting for the log messages to screen,</span>
<span class="sd">                    default is &#39;critical&#39; messages only.</span>
<span class="sd">                    Note: independent of logLevel setting, all messages always  </span>
<span class="sd">                    go to the logfile if it is not turned off.</span>
<span class="sd">    :type logLevel: integer from 0-6, 0=nothing to screen, 6=everything to </span>
<span class="sd">                    screen. OR the message level as a string (ie. &#39;critical&#39;,  </span>
<span class="sd">                    &#39;status&#39;, &#39;fullinfo&#39;...)</span>
<span class="sd">    </span>
<span class="sd">    :param noLogFile: A boolean to make it so no log file is created</span>
<span class="sd">    :type noLogFile: Python boolean (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Instantiate ScienceFunctionManager object</span>
    <span class="n">sfm</span> <span class="o">=</span> <span class="n">gemt</span><span class="o">.</span><span class="n">ScienceFunctionManager</span><span class="p">(</span><span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span>
                                      <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span><span class="p">,</span> 
                                      <span class="n">funcName</span><span class="o">=</span><span class="s">&#39;overscan_trim&#39;</span><span class="p">)</span> 
    <span class="c"># Perform start up checks of the inputs, prep/check of outnames, and get log</span>
    <span class="c"># and the log params for later use if needed.</span>
    <span class="n">adInputs</span><span class="p">,</span> <span class="n">outNames</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">logName</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">,</span> <span class="n">noLogFile</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">startUp</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Set up counter for looping through outNames list</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c"># Creating empty list of ad&#39;s to be returned that will be filled below</span>
        <span class="n">adOutputs</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="c"># Loop through the inputs to perform the non-linear and saturated</span>
        <span class="c"># pixel searches of the SCI frames to update the BPM frames into</span>
        <span class="c"># full DQ frames. </span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">adInputs</span><span class="p">:</span>  
            <span class="c"># Making a deepcopy of the input to work on</span>
            <span class="c"># (ie. a truly new+different object that is a complete copy of the input)</span>
            <span class="n">adOut</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
            <span class="c"># moving the filename over as deepcopy doesn&#39;t do that</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">filename</span>
                             
            <span class="c"># To clean up log and screen if multiple inputs</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;format&#39;</span><span class="p">)</span>    
            
            <span class="k">for</span> <span class="n">sciExt</span> <span class="ow">in</span> <span class="n">adOut</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]:</span>
                <span class="c"># Getting the data section from the header and as a dict</span>
                <span class="c"># and grabbing the integer list from it, then finding</span>
                <span class="c"># its shape</span>
                <span class="n">datasecDict</span> <span class="o">=</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">data_section</span><span class="p">()</span>
                <span class="n">datasecStr</span> <span class="o">=</span> <span class="n">sciExt</span><span class="o">.</span><span class="n">data_section</span><span class="p">(</span><span class="n">pretty</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">asDict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="c"># NOTE: this list is zero based, like python and numpy</span>
                <span class="n">datasecList</span> <span class="o">=</span> <span class="n">datasecDict</span><span class="p">[(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extname</span><span class="p">(),</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())]</span> 
                <span class="n">dsl</span> <span class="o">=</span> <span class="n">datasecList</span>
                
                <span class="c"># Updating logger with the section being kept</span>
                <span class="n">log</span><span class="o">.</span><span class="n">stdinfo</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">for &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39; extension &#39;</span><span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span>
                            <span class="s">&#39;, keeping the data from the section &#39;</span><span class="o">+</span>
                            <span class="n">datasecStr</span><span class="p">,</span><span class="s">&#39;science&#39;</span><span class="p">)</span>
                <span class="c"># Trimming the data section from input SCI array</span>
                <span class="c"># and making it the new SCI data</span>
                <span class="c"># NOTE: first elements of arrays in python are inclusive</span>
                <span class="c">#       while last ones are exclusive, thus a 1 must be </span>
                <span class="c">#       added for the final element to be included.</span>
                <span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">sciExt</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="c"># Updating header keys to match new dimensions</span>
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">newDataSecStr</span> <span class="o">=</span> <span class="s">&#39;[1:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dsl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;,1:&#39;</span><span class="o">+</span>\
                                <span class="nb">str</span><span class="p">(</span><span class="n">dsl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">dsl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;]&#39;</span> 
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATASEC&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newDataSecStr</span>
                <span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;TRIMSEC&#39;</span><span class="p">,</span> <span class="n">datasecStr</span><span class="p">,</span> 
                                   <span class="s">&#39;Data section prior to trimming&#39;</span><span class="p">)</span>
                <span class="c"># Updating logger with updated/added keywords to each SCI frame</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;File = &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;SCI extension number &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">extver</span><span class="p">())</span><span class="o">+</span>
                             <span class="s">&#39; keywords updated/added:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;NAXIS1= &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;NAXIS1&#39;</span><span class="p">]),</span>
                            <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;NAXIS2= &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sciExt</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;NAXIS2&#39;</span><span class="p">]),</span>
                             <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;DATASEC= &#39;</span><span class="o">+</span><span class="n">newDataSecStr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;TRIMSEC= &#39;</span><span class="o">+</span><span class="n">datasecStr</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
                    
            <span class="c"># Updating GEM-TLM (automatic) and BIASCORR time stamps to the PHU</span>
            <span class="c"># and updating logger with updated/added time stamps</span>
            <span class="n">sfm</span><span class="o">.</span><span class="n">markHistory</span><span class="p">(</span><span class="n">adOutputs</span><span class="o">=</span><span class="n">adOut</span><span class="p">,</span> <span class="n">historyMarkKey</span><span class="o">=</span><span class="s">&#39;OVERTRIM&#39;</span><span class="p">)</span>       
            
            <span class="c"># Setting &#39;TRIMMED&#39; to &#39;yes&#39; in the PHU and updating the log</span>
            <span class="n">adOut</span><span class="o">.</span><span class="n">phuSetKeyValue</span><span class="p">(</span><span class="s">&#39;TRIMMED&#39;</span><span class="p">,</span><span class="s">&#39;yes&#39;</span><span class="p">,</span><span class="s">&#39;Overscan section trimmed&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;Another PHU keywords added:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;header&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fullinfo</span><span class="p">(</span><span class="s">&#39;TRIMMED = &#39;</span><span class="o">+</span><span class="n">adOut</span><span class="o">.</span><span class="n">phuGetKeyValue</span><span class="p">(</span><span class="s">&#39;TRIMMED&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> 
                         <span class="n">category</span><span class="o">=</span><span class="s">&#39;header&#39;</span><span class="p">)</span>
            
            <span class="c"># Appending to output list</span>
            <span class="n">adOutputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adOut</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">&#39;**FINISHED** the overscan_trim function&#39;</span><span class="p">)</span>
        
        <span class="c"># Return the outputs list, even if there is only one output</span>
        <span class="k">return</span> <span class="n">adOutputs</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># logging the exact message from the actual exception that was raised</span>
        <span class="c"># in the try block. Then raising a general ScienceError with message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">ScienceError</span><span class="p">(</span><span class="s">&#39;An error occurred while trying to run </span><span class="se">\</span>
<span class="s">                                                                overscan_trim&#39;</span><span class="p">)</span>




                
                
                
                
                
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../../index.html">gempy v0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, nz.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>